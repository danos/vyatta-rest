#!/usr/bin/perl
#
# Copyright (c) 2019, AT&T Intellectual Property.  All rights reserved.
# Copyright (c) 2014 by Brocade Communications Systems, Inc.
# All rights reserved.
#
# SPDX-License-Identifier: GPL-2.0-only

use strict;
use warnings;

use lib '/opt/vyatta/share/perl5';
use Vyatta::Config;

my $lighttpd_service_file = '/etc/lighttpd/conf-enabled/11-vyatta-webuig2-service.conf';
my $config = new Vyatta::Config;
$config->setLevel('service https');



my $enable_service = '
"^/service$" => "$0",
"^/service/$" => "/Vyatta2/vya_service.html",
"^/service/(.*)/(.*)" => "/Vyatta2/$1/$2",
"^/service/(.*).gif" => "/Vyatta2/$1.gif",
';

my $disable_service = '
"^/Vyatta2/vya_service.html$" => "/cgi-bin/disabled.cgi",
"^/rest/service" => "/cgi-bin/disabled.cgi",
"^/service" => "/cgi-bin/disabled.cgi",
';


my $rewrite_rules;
if ($config->exists("service-users")) {
	$rewrite_rules = $enable_service;
} else {
	$rewrite_rules = $disable_service;
}

my $lighttpd_service_cfg = '
#
## This file is auto-generated by vyatta-webgui2.
## Do not edit, all changes will be lost!
#
server.modules += ("mod_rewrite")

url.rewrite-once = (
'. $rewrite_rules .'
)

url.redirect += (
   "^/service$" => "/service/",
   "^/service/vya_service.html$" => "/service/",
)
';

open(my $fd, '>', $lighttpd_service_file) or
	die "Cannot write https service config file $lighttpd_service_file: $!";
print $fd $lighttpd_service_cfg;
close $fd;

